name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install osquery
        run: |
          # Install osquery from official repository
          # https://osquery.io/downloads/official
          curl -L https://pkg.osquery.io/deb/osquery.gpg | sudo apt-key add -
          sudo add-apt-repository 'deb [arch=amd64] https://pkg.osquery.io/deb deb main'
          sudo apt-get update
          sudo apt-get install -y osquery

      - name: Build test Docker image
        run: ./scripts/build-test-image.sh

      - name: Generate coverage report
        run: |
          # Run coverage with osquery installed natively for integration tests
          # Docker tests are also included for additional coverage
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info --ignore-filename-regex "_osquery"
        timeout-minutes: 15

      - name: Calculate coverage percentage
        id: coverage
        run: |
          # Get coverage percentage from cargo-llvm-cov (excluding auto-generated code)
          COVERAGE=$(cargo llvm-cov --all-features --workspace --json --ignore-filename-regex "_osquery" 2>/dev/null | jq -r '.data[0].totals.lines.percent // 0' | xargs printf "%.1f")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
        timeout-minutes: 15

      - name: Update coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: 36626ec8e61a6ccda380befc41f2cae1
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.coverage }}%
          valColorRange: ${{ steps.coverage.outputs.coverage }}
          maxColorRange: 100
          minColorRange: 0

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        continue-on-error: true
