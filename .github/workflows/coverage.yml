name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Build test Docker image
        run: ./scripts/build-test-image.sh

      - name: Generate coverage report
        run: |
          # Run coverage inside Docker container where osquery is available
          # This allows all integration tests to run and be measured
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            -e CARGO_TERM_COLOR=always \
            osquery-rust-test:latest \
            sh -c '
              # Install cargo-llvm-cov inside container
              rustup component add llvm-tools-preview
              cargo install cargo-llvm-cov

              # Start osqueryd in background with extensions autoloaded
              osqueryd --ephemeral \
                --disable_extensions=false \
                --extensions_socket=/var/osquery/osquery.em \
                --extensions_autoload=/etc/osquery/extensions.load \
                --database_path=/tmp/osquery.db \
                --disable_watchdog \
                --force &

              # Wait for osquery socket to be ready
              for i in $(seq 1 30); do
                if [ -S /var/osquery/osquery.em ]; then
                  echo "osquery socket ready"
                  break
                fi
                sleep 1
              done

              # Set socket path for tests
              export OSQUERY_SOCKET=/var/osquery/osquery.em

              # Generate coverage with all features
              cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info --ignore-filename-regex "_osquery"
            '
        timeout-minutes: 20

      - name: Calculate coverage percentage
        id: coverage
        run: |
          # Extract coverage percentage from lcov.info
          if [ -f lcov.info ]; then
            LINES_HIT=$(grep -E "^LH:" lcov.info | cut -d: -f2 | paste -sd+ | bc)
            LINES_FOUND=$(grep -E "^LF:" lcov.info | cut -d: -f2 | paste -sd+ | bc)
            if [ "$LINES_FOUND" -gt 0 ]; then
              COVERAGE=$(echo "scale=1; $LINES_HIT * 100 / $LINES_FOUND" | bc)
            else
              COVERAGE="0.0"
            fi
          else
            COVERAGE="0.0"
          fi
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
        timeout-minutes: 5

      - name: Update coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: 36626ec8e61a6ccda380befc41f2cae1
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.coverage }}%
          valColorRange: ${{ steps.coverage.outputs.coverage }}
          maxColorRange: 100
          minColorRange: 0

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        continue-on-error: true
